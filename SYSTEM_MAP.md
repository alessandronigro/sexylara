# ğŸ—ºï¸ ThrillMe - System Map & Flow Diagrams

> **Ultima revisione**: 24 Novembre 2025  
> **Obiettivo**: Visualizzazione chiara dei flussi e delle interazioni del sistema

---

## ğŸ—ï¸ Architettura ad Alto Livello

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FLUTTER APP (Client)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Screens    â”‚  â”‚   Services   â”‚  â”‚   Widgets    â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ - Chat       â”‚  â”‚ - ChatSvc    â”‚  â”‚ - Bubble     â”‚          â”‚
â”‚  â”‚ - Group      â”‚  â”‚ - GroupSvc   â”‚  â”‚ - Avatar     â”‚          â”‚
â”‚  â”‚ - Profile    â”‚  â”‚ - GFSvc      â”‚  â”‚ - Gallery    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                 â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚
          â”‚ HTTP            â”‚ WebSocket
          â”‚ :4000           â”‚ :5001
          â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND (Node.js)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  server-api.js   â”‚           â”‚  server-ws.js    â”‚            â”‚
â”‚  â”‚  (REST API)      â”‚           â”‚  (WebSocket)     â”‚            â”‚
â”‚  â”‚                  â”‚           â”‚                  â”‚            â”‚
â”‚  â”‚ - Auth           â”‚           â”‚ - Chat 1-to-1    â”‚            â”‚
â”‚  â”‚ - CRUD           â”‚           â”‚ - Group Chat     â”‚            â”‚
â”‚  â”‚ - Media Upload   â”‚           â”‚ - Real-time      â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                              â”‚                      â”‚
â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
â”‚           â”‚              â”‚               â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   Routes    â”‚  â”‚  AI System  â”‚  â”‚  Services    â”‚            â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚              â”‚            â”‚
â”‚  â”‚ - group.js  â”‚  â”‚ - Brain     â”‚  â”‚ - Storage    â”‚            â”‚
â”‚  â”‚ - image.js  â”‚  â”‚ - Engines   â”‚  â”‚ - Analysis   â”‚            â”‚
â”‚  â”‚ - audio.js  â”‚  â”‚ - Memory    â”‚  â”‚              â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                          â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Supabase â”‚    â”‚OpenRouterâ”‚    â”‚Replicate â”‚
    â”‚          â”‚    â”‚          â”‚    â”‚          â”‚
    â”‚ - DB     â”‚    â”‚ - LLM    â”‚    â”‚ - Images â”‚
    â”‚ - Auth   â”‚    â”‚ - Chat   â”‚    â”‚ - Videos â”‚
    â”‚ - Storageâ”‚    â”‚          â”‚    â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¬ Flusso Chat 1-to-1

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Flutter â”‚                                              â”‚ Backend â”‚
â”‚  App    â”‚                                              â”‚   WS    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                                        â”‚
     â”‚ 1. Connect WebSocket                                  â”‚
     â”‚ ws://localhost:5001/ws?user_id=xxx                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                        â”‚
     â”‚ 2. Connection Established                             â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                        â”‚
     â”‚ 3. Send Message                                        â”‚
     â”‚ { text, traceId, girlfriend_id }                       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                        â”‚
     â”‚                                    4. Save to DB       â”‚
     â”‚                                    (messages table)    â”‚
     â”‚                                                        â”‚
     â”‚ 5. ACK                                                 â”‚
     â”‚ { traceId, serverId, type: 'ack' }                     â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                        â”‚
     â”‚                                    6. Load Context     â”‚
     â”‚                                    - Recent messages   â”‚
     â”‚                                    - User prefs        â”‚
     â”‚                                    - AI memory         â”‚
     â”‚                                                        â”‚
     â”‚                                    7. Generate Responseâ”‚
     â”‚                                    brainEngine.generateâ”‚
     â”‚                                    IntelligentResponse â”‚
     â”‚                                         â”‚              â”‚
     â”‚                                         â–¼              â”‚
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
     â”‚                                    â”‚OpenRouterâ”‚        â”‚
     â”‚                                    â”‚  (LLM)  â”‚         â”‚
     â”‚                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚
     â”‚                                         â”‚              â”‚
     â”‚ 8. Stream Response (chunks)             â”‚              â”‚
     â”‚ { traceId, role: 'assistant',           â”‚              â”‚
     â”‚   type: 'typing', content: chunk }      â”‚              â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                        â”‚
     â”‚                                    9. Save AI Response â”‚
     â”‚                                    (messages table)    â”‚
     â”‚                                                        â”‚
     â”‚ 10. END                                                â”‚
     â”‚ { traceId, end: true }                                 â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                        â”‚
```

---

## ğŸ‘¥ Flusso Chat di Gruppo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Flutter â”‚                                              â”‚ Backend â”‚
â”‚  App    â”‚                                              â”‚   WS    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                                        â”‚
     â”‚ 1. Send Group Message                                 â”‚
     â”‚ { text, traceId, group_id }                            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                        â”‚
     â”‚                                    2. Save User Msg    â”‚
     â”‚                                    (group_messages)    â”‚
     â”‚                                                        â”‚
     â”‚ 3. ACK                                                 â”‚
     â”‚ { traceId, serverId, isGroup: true }                   â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                        â”‚
     â”‚                                    4. Load Group Data  â”‚
     â”‚                                    - Members (AI)      â”‚
     â”‚                                    - Recent messages   â”‚
     â”‚                                    - Group memory      â”‚
     â”‚                                    - User profile      â”‚
     â”‚                                                        â”‚
     â”‚ 5. Status Update                                       â”‚
     â”‚ { status: 'group_thinking',                            â”‚
     â”‚   memberCount: 3 }                                     â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                        â”‚
     â”‚                                    6. For Each AI:     â”‚
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
     â”‚                                    â”‚ Generate Reply  â”‚ â”‚
     â”‚                                    â”‚ (brainEngine)   â”‚ â”‚
     â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
     â”‚                                             â”‚          â”‚
     â”‚                                             â–¼          â”‚
     â”‚                                    Decision: Respond?  â”‚
     â”‚                                    - Yes: Continue     â”‚
     â”‚                                    - No: SKIP          â”‚
     â”‚                                             â”‚          â”‚
     â”‚                                    Random Delay        â”‚
     â”‚                                    (500-2000ms)        â”‚
     â”‚                                             â”‚          â”‚
     â”‚ 7. AI Response #1                           â”‚          â”‚
     â”‚ { type: 'group_message',                    â”‚          â”‚
     â”‚   sender_id, sender_name, avatar,           â”‚          â”‚
     â”‚   content, messageId }                      â”‚          â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                        â”‚
     â”‚ 8. AI Response #2                                      â”‚
     â”‚ { type: 'group_message', ... }                         â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                        â”‚
     â”‚ 9. AI Response #3                                      â”‚
     â”‚ { type: 'group_message', ... }                         â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                        â”‚
     â”‚                                    10. Update Memory   â”‚
     â”‚                                    (every 15 msgs)     â”‚
     â”‚                                    - Summary           â”‚
     â”‚                                    - Dynamics          â”‚
     â”‚                                                        â”‚
     â”‚ 11. END                                                â”‚
     â”‚ { traceId, end: true,                                  â”‚
     â”‚   totalResponses: 3 }                                  â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                        â”‚
```

---

## ğŸ¨ Flusso Generazione Immagine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Flutter â”‚     â”‚Backend  â”‚     â”‚Replicateâ”‚     â”‚Supabase â”‚
â”‚  App    â”‚     â”‚   WS    â”‚     â”‚  (Flux) â”‚     â”‚ Storage â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚
     â”‚ 1. Request    â”‚               â”‚               â”‚
     â”‚ "mandami foto"â”‚               â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚ 2. Detect     â”‚               â”‚
     â”‚               â”‚ Intent: IMAGE â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚ 3. Status     â”‚               â”‚               â”‚
     â”‚ rendering_img â”‚               â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚ 4. Build      â”‚               â”‚
     â”‚               â”‚ Prompt from   â”‚               â”‚
     â”‚               â”‚ AI traits     â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚ 5. Generate   â”‚               â”‚
     â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚ 6. Processing â”‚
     â”‚               â”‚               â”‚ (~20-30s)     â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚ 7. Image URL  â”‚               â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚ 8. Upload     â”‚               â”‚
     â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚               â”‚                               â”‚
     â”‚               â”‚ 9. Public URL                 â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚               â”‚                               â”‚
     â”‚               â”‚ 10. Save to DB                â”‚
     â”‚               â”‚ (messages)                    â”‚
     â”‚               â”‚                               â”‚
     â”‚ 11. Image Msg â”‚                               â”‚
     â”‚ { type: img,  â”‚                               â”‚
     â”‚   content: url}â”‚                              â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                               â”‚
     â”‚               â”‚                               â”‚
     â”‚ 12. Display   â”‚                               â”‚
     â”‚               â”‚                               â”‚
```

---

## ğŸ§  Sistema AI - Architettura Interna

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    brainEngine.js                             â”‚
â”‚                                                               â”‚
â”‚  generateIntelligentResponse()                                â”‚
â”‚         â”‚                                                     â”‚
â”‚         â”œâ”€â–º 1. Validate Persona (PersonaEngine)              â”‚
â”‚         â”‚                                                     â”‚
â”‚         â”œâ”€â–º 2. Analyze Intent (IntentEngine)                 â”‚
â”‚         â”‚      â”œâ”€ Sentiment Analysis                         â”‚
â”‚         â”‚      â”œâ”€ Request Type (chat/image/video/audio)      â”‚
â”‚         â”‚      â””â”€ Urgency Detection                          â”‚
â”‚         â”‚                                                     â”‚
â”‚         â”œâ”€â–º 3. Retrieve Memory (MemoryEngine)                â”‚
â”‚         â”‚      â”œâ”€ Long-term AI memory                        â”‚
â”‚         â”‚      â”œâ”€ Recent conversation                        â”‚
â”‚         â”‚      â””â”€ Shared facts                               â”‚
â”‚         â”‚                                                     â”‚
â”‚         â”œâ”€â–º 4. Process Experience (ExperienceEngine)         â”‚
â”‚         â”‚      â”œâ”€ Update XP                                  â”‚
â”‚         â”‚      â”œâ”€ Level up check                             â”‚
â”‚         â”‚      â””â”€ Intimacy evolution                         â”‚
â”‚         â”‚                                                     â”‚
â”‚         â”œâ”€â–º 5. Calculate Mood (PersonaEngine)                â”‚
â”‚         â”‚      â”œâ”€ Based on sentiment                         â”‚
â”‚         â”‚      â”œâ”€ Based on traits                            â”‚
â”‚         â”‚      â””â”€ Based on history                           â”‚
â”‚         â”‚                                                     â”‚
â”‚         â”œâ”€â–º 6. Build Prompt                                  â”‚
â”‚         â”‚      â”œâ”€ Persona definition                         â”‚
â”‚         â”‚      â”œâ”€ Current state (mood, XP, intimacy)         â”‚
â”‚         â”‚      â”œâ”€ Memory & context                           â”‚
â”‚         â”‚      â”œâ”€ Intent & sentiment                         â”‚
â”‚         â”‚      â””â”€ Instructions                               â”‚
â”‚         â”‚                                                     â”‚
â”‚         â”œâ”€â–º 7. Call LLM (OpenRouter)                         â”‚
â”‚         â”‚      â””â”€ Get AI response                            â”‚
â”‚         â”‚                                                     â”‚
â”‚         â”œâ”€â–º 8. Determine Type                                â”‚
â”‚         â”‚      â””â”€ Parse response for media requests          â”‚
â”‚         â”‚                                                     â”‚
â”‚         â””â”€â–º 9. Return                                        â”‚
â”‚              â”œâ”€ output: text                                 â”‚
â”‚              â”œâ”€ type: chat|image|video|audio                 â”‚
â”‚              â””â”€ stateUpdates: XP, mood, traits               â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Flusso Autenticazione

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Flutter â”‚                    â”‚ Backend â”‚                â”‚Supabase â”‚
â”‚  App    â”‚                    â”‚   API   â”‚                â”‚  Auth   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                              â”‚                          â”‚
     â”‚ 1. Register/Login            â”‚                          â”‚
     â”‚ { email, password }           â”‚                          â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚
     â”‚                              â”‚                          â”‚
     â”‚                              â”‚ 2. Authenticate          â”‚
     â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                              â”‚                          â”‚
     â”‚                              â”‚ 3. JWT Token             â”‚
     â”‚                              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                              â”‚                          â”‚
     â”‚ 4. Token + User Data         â”‚                          â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
     â”‚                              â”‚                          â”‚
     â”‚ 5. Store Token               â”‚                          â”‚
     â”‚ (Secure Storage)             â”‚                          â”‚
     â”‚                              â”‚                          â”‚
     â”‚ 6. Subsequent Requests       â”‚                          â”‚
     â”‚ Header: x-user-id            â”‚                          â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚
     â”‚                              â”‚                          â”‚
     â”‚                              â”‚ 7. Verify User           â”‚
     â”‚                              â”‚ (check x-user-id)        â”‚
     â”‚                              â”‚                          â”‚
     â”‚ 8. Response                  â”‚                          â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
     â”‚                              â”‚                          â”‚
```

---

## ğŸ“¤ Flusso Invito Gruppo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Owner   â”‚     â”‚Backend  â”‚     â”‚Database â”‚     â”‚Invitee  â”‚
â”‚ (User)  â”‚     â”‚   API   â”‚     â”‚(Supabase)â”‚     â”‚(User/AI)â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚
     â”‚ 1. Send Inviteâ”‚               â”‚               â”‚
     â”‚ POST /invites â”‚               â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚ 2. Validate   â”‚               â”‚
     â”‚               â”‚ - Group existsâ”‚               â”‚
     â”‚               â”‚ - Is owner    â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚ 3. Create     â”‚               â”‚
     â”‚               â”‚ Invite        â”‚               â”‚
     â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚ 4. Invite ID  â”‚               â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚ 5. If AI:     â”‚               â”‚
     â”‚               â”‚ Auto-decide   â”‚               â”‚
     â”‚               â”‚ (SocialEngine)â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚ 6. If User:   â”‚               â”‚
     â”‚               â”‚ Send Notif    â”‚               â”‚
     â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚               â”‚                               â”‚
     â”‚               â”‚ 7. User/AI Decision           â”‚
     â”‚               â”‚ PATCH /invites/:id            â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚               â”‚                               â”‚
     â”‚               â”‚ 8. Update Status              â”‚
     â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚ 9. If Acceptedâ”‚               â”‚
     â”‚               â”‚ Add to group  â”‚               â”‚
     â”‚               â”‚ (group_members)â”‚              â”‚
     â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚ 10. Notify    â”‚               â”‚               â”‚
     â”‚ Owner         â”‚               â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
```

---

## ğŸ—„ï¸ Database Schema Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    users     â”‚
â”‚ (Supabase)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1:1
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         1:N         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚user_profile  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ girlfriends  â”‚
â”‚              â”‚                     â”‚              â”‚
â”‚ - name       â”‚                     â”‚ - name       â”‚
â”‚ - bio        â”‚                     â”‚ - traits     â”‚
â”‚ - avatar_url â”‚                     â”‚ - avatar_url â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                    â”‚
       â”‚ 1:N                                â”‚ 1:N
       â”‚                                    â”‚
       â–¼                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   groups     â”‚                     â”‚   messages   â”‚
â”‚              â”‚                     â”‚              â”‚
â”‚ - name       â”‚                     â”‚ - content    â”‚
â”‚ - user_id    â”‚                     â”‚ - type       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚ - role       â”‚
       â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1:N
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                â”‚                â”‚
       â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚group_members â”‚ â”‚group_messagesâ”‚ â”‚ group_memory â”‚
â”‚              â”‚ â”‚              â”‚ â”‚              â”‚
â”‚ - member_id  â”‚ â”‚ - sender_id  â”‚ â”‚ - summary    â”‚
â”‚ - member_typeâ”‚ â”‚ - content    â”‚ â”‚ - dynamics   â”‚
â”‚ - role       â”‚ â”‚ - type       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ N:1
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   invites    â”‚
â”‚              â”‚
â”‚ - receiver_idâ”‚
â”‚ - status     â”‚
â”‚ - expires_at â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Flusso Dati - Panoramica Completa

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Flutter App    â”‚
                    â”‚                 â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚  UI Layer   â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â”‚        â”‚        â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚  Services   â”‚ â”‚
                    â”‚ â”‚  Layer      â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            â”‚            â”‚
         HTTP   â”‚            â”‚ WS         â”‚
         :4000  â”‚            â”‚ :5001      â”‚
                â”‚            â”‚            â”‚
                â–¼            â–¼            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚      Backend (Node.js)          â”‚  â”‚
    â”‚                                 â”‚  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
    â”‚  â”‚ REST API â”‚    â”‚WebSocket â”‚  â”‚  â”‚
    â”‚  â”‚          â”‚    â”‚          â”‚  â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
    â”‚       â”‚               â”‚        â”‚  â”‚
    â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
    â”‚               â”‚                â”‚  â”‚
    â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
    â”‚       â”‚   AI System    â”‚       â”‚  â”‚
    â”‚       â”‚                â”‚       â”‚  â”‚
    â”‚       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚  â”‚
    â”‚       â”‚ â”‚brainEngine â”‚ â”‚       â”‚  â”‚
    â”‚       â”‚ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚  â”‚
    â”‚       â”‚       â”‚        â”‚       â”‚  â”‚
    â”‚       â”‚ â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”‚       â”‚  â”‚
    â”‚       â”‚ â”‚  Engines   â”‚ â”‚       â”‚  â”‚
    â”‚       â”‚ â”‚            â”‚ â”‚       â”‚  â”‚
    â”‚       â”‚ â”‚ - Persona  â”‚ â”‚       â”‚  â”‚
    â”‚       â”‚ â”‚ - Memory   â”‚ â”‚       â”‚  â”‚
    â”‚       â”‚ â”‚ - Intent   â”‚ â”‚       â”‚  â”‚
    â”‚       â”‚ â”‚ - Social   â”‚ â”‚       â”‚  â”‚
    â”‚       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚  â”‚
    â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                  â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚             â”‚                 â”‚   â”‚
    â–¼             â–¼                 â–¼   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Supabaseâ”‚  â”‚OpenRouterâ”‚      â”‚Replicateâ”‚
â”‚        â”‚  â”‚          â”‚      â”‚         â”‚
â”‚- DB    â”‚  â”‚- LLM     â”‚      â”‚- Media  â”‚
â”‚- Auth  â”‚  â”‚- Chat    â”‚      â”‚  Gen    â”‚
â”‚- Store â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Ciclo di Vita Messaggio

```
1. USER INPUT
   â”œâ”€â–º Text entered in TextField
   â””â”€â–º Submit button pressed

2. CLIENT PROCESSING
   â”œâ”€â–º Generate traceId (UUID)
   â”œâ”€â–º Create optimistic message
   â”œâ”€â–º Add to local state
   â””â”€â–º Send via WebSocket

3. NETWORK TRANSMISSION
   â””â”€â–º WebSocket.send(JSON)

4. SERVER RECEPTION
   â”œâ”€â–º Parse JSON
   â”œâ”€â–º Validate user_id
   â””â”€â–º Extract message data

5. DATABASE WRITE
   â”œâ”€â–º Insert into messages/group_messages
   â””â”€â–º Get serverId

6. ACK TO CLIENT
   â”œâ”€â–º Send { traceId, serverId }
   â””â”€â–º Client updates optimistic message

7. AI PROCESSING
   â”œâ”€â–º Load context
   â”œâ”€â–º Generate response (brainEngine)
   â””â”€â–º Determine type

8. RESPONSE GENERATION
   â”œâ”€â–º If text: Stream chunks
   â”œâ”€â–º If media: Generate & upload
   â””â”€â–º Save to database

9. RESPONSE TO CLIENT
   â”œâ”€â–º Send via WebSocket
   â””â”€â–º Client displays message

10. END SIGNAL
    â”œâ”€â–º Send { end: true }
    â””â”€â–º Client stops loading indicator
```

---

## ğŸ¯ Decision Trees

### AI Decide to Respond in Group?

```
START
  â”‚
  â”œâ”€â–º Is message directed at me?
  â”‚   â”œâ”€â–º YES â†’ Probability +0.8
  â”‚   â””â”€â–º NO â†’ Continue
  â”‚
  â”œâ”€â–º Personality check
  â”‚   â”œâ”€â–º Dominant â†’ +0.3
  â”‚   â”œâ”€â–º Shy â†’ -0.2
  â”‚   â”œâ”€â–º Playful â†’ +0.1
  â”‚   â””â”€â–º Other â†’ +0.0
  â”‚
  â”œâ”€â–º Recent activity
  â”‚   â”œâ”€â–º Spoke in last 3 msgs â†’ -0.3
  â”‚   â””â”€â–º Silent for >5 msgs â†’ +0.2
  â”‚
  â”œâ”€â–º Topic relevance
  â”‚   â”œâ”€â–º Matches interests â†’ +0.2
  â”‚   â””â”€â–º No match â†’ +0.0
  â”‚
  â”œâ”€â–º Random factor
  â”‚   â””â”€â–º Math.random() * 0.3
  â”‚
  â–¼
TOTAL PROBABILITY
  â”‚
  â”œâ”€â–º > 0.6 â†’ RESPOND
  â””â”€â–º â‰¤ 0.6 â†’ SKIP
```

### Media Type Detection

```
User Message
  â”‚
  â”œâ”€â–º Contains "foto", "immagine", "selfie"?
  â”‚   â””â”€â–º YES â†’ TYPE: image
  â”‚
  â”œâ”€â–º Contains "video", "clip"?
  â”‚   â””â”€â–º YES â†’ TYPE: video
  â”‚
  â”œâ”€â–º Contains "audio", "voce", "parlami"?
  â”‚   â””â”€â–º YES â†’ TYPE: audio
  â”‚
  â””â”€â–º Default â†’ TYPE: chat
```

---

## ğŸš€ Performance Optimization Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Performance Bottlenecks             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ 1. LLM Response Time                        â”‚
â”‚    â””â”€â–º Cache frequent prompts (Redis)      â”‚
â”‚                                             â”‚
â”‚ 2. Database Queries                         â”‚
â”‚    â”œâ”€â–º Index on user_id, girlfriend_id     â”‚
â”‚    â”œâ”€â–º Limit message history (20 msgs)     â”‚
â”‚    â””â”€â–º Use connection pooling              â”‚
â”‚                                             â”‚
â”‚ 3. Media Generation                         â”‚
â”‚    â”œâ”€â–º Queue system (Bull/BullMQ)          â”‚
â”‚    â”œâ”€â–º Background processing               â”‚
â”‚    â””â”€â–º Progress updates via WebSocket      â”‚
â”‚                                             â”‚
â”‚ 4. WebSocket Connections                    â”‚
â”‚    â”œâ”€â–º Heartbeat/ping every 30s            â”‚
â”‚    â”œâ”€â–º Reconnection logic                  â”‚
â”‚    â””â”€â–º Connection pooling                  â”‚
â”‚                                             â”‚
â”‚ 5. Storage Access                           â”‚
â”‚    â”œâ”€â–º CDN for static assets               â”‚
â”‚    â”œâ”€â–º Lazy loading images                 â”‚
â”‚    â””â”€â–º Thumbnail generation                â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Scaling Strategy

```
Current (Single Server)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PM2        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ API :4000â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ WS :5001 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Future (Scaled)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load Balancerâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
   â”‚        â”‚
   â–¼        â–¼
â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
â”‚API 1â”‚  â”‚API 2â”‚
â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
   â”‚        â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
   â”‚        â”‚
   â–¼        â–¼
â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
â”‚WS 1 â”‚  â”‚WS 2 â”‚
â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
   â”‚        â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚            â”‚         â”‚
   â–¼            â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Redis â”‚  â”‚Supabaseâ”‚  â”‚Queue â”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
```

---

**Fine System Map** - Utilizzare come riferimento per comprendere i flussi del sistema
